<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVG | Maintenance Pro-Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        :root {
            --primary: #002b5c;
            --accent: #00d4ff;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: #1e293b; padding: 10px; }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (min-width: 768px) {
            body { padding: 20px; }
        }

        .alert-marquee {
            background: #fee2e2; color: #ef4444; padding: 12px; border-radius: 12px;
            margin-bottom: 20px; font-weight: 800; border: 2px solid #ef4444;
            display: none; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .blink-danger { animation: blinker 0.6s linear infinite; background-color: var(--danger) !important; color: white !important; }
        @keyframes blinker { 50% { opacity: 0.2; } }

        #toast {
            position: fixed; top: 20px; right: 20px; 
            background: var(--success); color: white; padding: 15px 25px;
            border-radius: 12px; font-weight: 800; box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            display: none; z-index: 10000; animation: slideIn 0.5s ease-out;
        }

        /* --- LOGIN BOX RESPONSIVE --- */
        .login-box { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
            padding: 40px 25px; border-radius: 30px; width: 90%; max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); text-align: center;
        }

        /* --- HEADER RESPONSIVE --- */
        header {
            display: flex; flex-direction: column; gap: 15px;
            background: var(--card); padding: 20px; border-radius: 20px;
            margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        @media (min-width: 1024px) {
            header { flex-direction: row; justify-content: space-between; align-items: center; }
        }

        /* --- KPI GRID RESPONSIVE --- */
        .kpi-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; 
        }
        @media (min-width: 1024px) {
            .kpi-grid { grid-template-columns: repeat(4, 1fr); gap: 20px; }
        }

        .kpi-card { background: var(--card); padding: 20px; border-radius: 20px; border-left: 5px solid var(--primary); }
        .kpi-card .val { font-size: 1.4rem; font-weight: 800; color: var(--primary); }

        /* --- MAIN LAYOUT RESPONSIVE --- */
        .main-layout { display: grid; grid-template-columns: 1fr; gap: 25px; }
        @media (min-width: 1024px) {
            .main-layout { grid-template-columns: 400px 1fr; }
        }

        .panel { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        /* --- TABLE RESPONSIVE --- */
        .table-container { width: 100%; overflow-x: auto; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; } /* Min-width prevents squeezing on mobile */
        
        /* Modal and Overlays */
        #login-overlay { position: fixed; inset: 0; background: radial-gradient(circle at top right, #003a7d, #001a38); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        #closeModal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 20000; display: none; justify-content: center; align-items: center; padding: 15px; }
        #pro-analytics-overlay { position: fixed; inset: 0; background: #f0f2f5; z-index: 10001; display: none; padding: 20px; overflow-y: auto; }

        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); opacity: 0.5; }
        .login-box input { width: 100%; padding: 15px 15px 15px 45px; border-radius: 15px; border: 1px solid #e2e8f0; }

        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        @media (min-width: 768px) { .stats-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

    <div id="closeModal">
        <div class="panel" style="width:100%; max-width:450px; border-top: 5px solid var(--accent);">
            <h3 style="margin-bottom:20px;"><i class="fa-solid fa-file-signature"></i> D√©tails de Cl√¥ture</h3>
            <input type="hidden" id="modal-id">
            <div class="form-group"><label>Type d'arr√™t</label><select id="modal-type"><option value="M√©canique">üîß M√©canique</option><option value="√âlectrique">‚ö° √âlectrique</option><option value="Process">‚öôÔ∏è Process</option></select></div>
            <div class="form-group"><label>Probl√®me</label><input type="text" id="modal-prob"></div>
            <div class="form-group"><label>Action</label><input type="text" id="modal-action"></div>
            <div class="form-group"><label>Heure FIN</label><input type="text" id="modal-end"></div>
            <button class="btn-primary" onclick="confirmClosing()">VALIDER</button>
            <button class="btn-primary" style="background:#64748b; margin-top:10px;" onclick="document.getElementById('closeModal').style.display='none'">ANNULER</button>
        </div>
    </div>

    <div id="login-overlay">
        <div class="login-box">
            <h2>CVG Dynamics</h2>
            <div class="input-group"><i class="fa-solid fa-user"></i><input type="text" id="u-name" placeholder="User"></div>
            <div class="input-group"><i class="fa-solid fa-lock"></i><input type="password" id="u-pass" placeholder="Password"></div>
            <button class="btn-primary" onclick="handleLogin()">SE CONNECTER</button>
        </div>
    </div>

    <div class="container" id="app-content" style="display:none;">
        <header>
            <h1>CVG <span style="color:var(--accent)">DYNAMICS</span></h1>
            <div id="user-info"></div>
            <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="openProDashboard()">DASHBOARD</button>
        </header>

        <div id="dynamic-alert-box" class="alert-marquee"></div>

        <div class="kpi-grid">
            <div class="kpi-card"><h3>Arr√™ts</h3><div class="val" id="kpi-count">0</div></div>
            <div class="kpi-card"><h3>Min</h3><div class="val" id="kpi-total">0</div></div>
            <div class="kpi-card"><h3>MTTR</h3><div class="val" id="kpi-mttr">0</div></div>
            <div class="kpi-card"><h3>Dispo</h3><div class="val" id="kpi-avail">100%</div></div>
        </div>

        <div class="main-layout">
            <div class="panel">
                <h3>Nouvel Arr√™t</h3>
                <select id="in-proj" onchange="updateMachines()" style="margin:10px 0; width:100%; padding:10px;"><option value="">Projet</option><option value="SKODA">SKODA</option><option value="CRAFTER">CRAFTER</option></select>
                <select id="in-mach" style="margin:10px 0; width:100%; padding:10px;"><option value="">Machine</option></select>
                <input type="text" id="in-START" placeholder="HH:MM" style="margin:10px 0; width:100%; padding:10px;">
                <button class="btn-primary" onclick="submitEntry()">OUVRIR</button>
            </div>
            <div class="panel">
                <div class="table-container">
                    <table>
                        <thead><tr><th>DATE</th><th>PROJET</th><th>MACHINE</th><th>START</th><th>END</th><th>DUR√âE</th><th>ACTION</th></tr></thead>
                        <tbody id="data-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const machineData = { "SKODA": ["80008172", "80008173"], "CRAFTER": ["80008119", "80008122"] };
        let users = JSON.parse(localStorage.getItem('cvg_pro_users')) || [{u: "admin", p: "cvg2024", role: "admin"}];
        let db = JSON.parse(localStorage.getItem('cvg_pro_db')) || [];
        let activeUser = null;

        function updateMachines() {
            const proj = document.getElementById('in-proj').value;
            const machSelect = document.getElementById('in-mach');
            machSelect.innerHTML = '<option value="">Machine</option>';
            if(proj && machineData[proj]) machineData[proj].forEach(m => { machSelect.innerHTML += `<option value="${m}">${m}</option>`; });
        }

        function handleLogin() {
            const u = document.getElementById('u-name').value;
            const p = document.getElementById('u-pass').value;
            const user = users.find(x => x.u === u && x.p === p);
            if(user) { activeUser = user; document.getElementById('login-overlay').style.display = 'none'; document.getElementById('app-content').style.display = 'block'; refreshUI(); }
            else alert("Error");
        }

        function submitEntry() {
            const p = document.getElementById('in-proj').value;
            const m = document.getElementById('in-mach').value;
            const s = document.getElementById('in-START').value;
            if(!p || !m || !s) return alert("Remplir tout!");
            db.unshift({ id: Date.now(), ts: new Date().toLocaleDateString(), proj: p, mach: m, START: s, END: "-", dur: 0, status: "PENDING", author: activeUser.u });
            localStorage.setItem('cvg_pro_db', JSON.stringify(db));
            refreshUI();
        }

        function refreshUI() {
            const table = document.getElementById('data-table');
            table.innerHTML = db.map(x => `<tr><td>${x.ts}</td><td>${x.proj}</td><td>${x.mach}</td><td>${x.START}</td><td>${x.END}</td><td>${x.dur} min</td><td>${x.status === 'PENDING' ? `<button onclick="closeIncident(${x.id})">FIN</button>` : 'Ferm√©'}</td></tr>`).join('');
            document.getElementById('kpi-count').innerText = db.length;
        }

        function closeIncident(id) {
            document.getElementById('modal-id').value = id;
            document.getElementById('closeModal').style.display = 'flex';
        }

        function confirmClosing() {
            const id = parseInt(document.getElementById('modal-id').value);
            const idx = db.findIndex(x => x.id === id);
            db[idx].END = document.getElementById('modal-end').value;
            db[idx].status = "DONE";
            db[idx].dur = 10; // Simple calc for example
            localStorage.setItem('cvg_pro_db', JSON.stringify(db));
            document.getElementById('closeModal').style.display = 'none';
            refreshUI();
        }
    </script>
</body>
</html>
