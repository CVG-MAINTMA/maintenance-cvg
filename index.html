<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVG | Maintenance Pro Sync</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Design dyalk lli m9ad */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --primary: #002b5c; --accent: #00d4ff; --success: #10b981; --danger: #ef4444; --bg: #f8fafc; --card: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: #1e293b; padding: 10px; }
        
        /* Layout */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .container { max-width: 1200px; margin: 0 auto; display: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        /* Cards */
        .panel { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .kpi { background: #eff6ff; padding: 15px; border-radius: 15px; text-align: center; border-left: 4px solid var(--primary); }
        .kpi h4 { font-size: 0.7rem; color: #64748b; text-transform: uppercase; }
        .kpi .val { font-size: 1.2rem; font-weight: 800; color: var(--primary); }

        /* Form & Table */
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; }
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .btn:active { transform: scale(0.98); }
        .table-wrap { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        
        /* Status */
        .status { padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.7rem; }
        .pending { background: #fee2e2; color: #ef4444; }
        .done { background: #dcfce7; color: #10b981; }

        /* Login */
        #login-screen { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .login-box { background: white; padding: 40px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; }

        /* Alerts */
        .alert { background: #ef4444; color: white; padding: 10px; border-radius: 10px; margin-bottom: 15px; display: none; font-weight: bold; }
        
        /* Modal */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:20px;">CVG Login</h2>
            <input type="text" id="user" placeholder="Utilisateur">
            <input type="password" id="pass" placeholder="Mot de passe">
            <button class="btn" onclick="login()">SE CONNECTER</button>
        </div>
    </div>

    <div id="modal">
        <div class="panel" style="width: 100%; max-width: 400px;">
            <h3>Clôturer l'arrêt</h3>
            <input type="hidden" id="m-id">
            <input type="text" id="m-end" placeholder="Heure Fin (HH:MM)">
            <input type="text" id="m-prob" placeholder="Mochkil (Problème)">
            <input type="text" id="m-sol" placeholder="L7al (Solution)">
            <button class="btn" onclick="saveClose()">VALIDER</button>
            <button class="btn" style="background:#64748b; margin-top:10px;" onclick="document.getElementById('modal').style.display='none'">ANNULER</button>
        </div>
    </div>

    <div class="container" id="main-app">
        <div class="header">
            <div>
                <h2 style="color:var(--primary)">CVG <span style="color:var(--accent)">PRO</span></h2>
                <small id="user-tag"></small>
            </div>
            <button onclick="location.reload()" style="padding:8px; border-radius:8px; background:#fee2e2; color:#ef4444; border:none;">Sortir</button>
        </div>

        <div id="alarm" class="alert">⚠️ MACHINE EN ARRÊT !</div>

        <div class="grid">
            <div class="panel">
                <h3>Nouvel Arrêt</h3>
                <select id="proj" onchange="updateMach()">
                    <option value="">-- Projet --</option>
                    <option value="SKODA">SKODA</option>
                    <option value="CRAFTER">CRAFTER</option>
                </select>
                <select id="mach"><option>-- Machine --</option></select>
                <input type="text" id="start-time" placeholder="Heure Début (HH:MM)">
                <button class="btn" onclick="addIncident()">OUVRIR L'ARRÊT</button>
                <div style="height: 200px; margin-top: 20px;">
                    <canvas id="myChart"></canvas>
                </div>
            </div>

            <div class="panel">
                <div class="kpi-grid">
                    <div class="kpi"><h4>Arrêts</h4><div class="val" id="count">0</div></div>
                    <div class="kpi"><h4>Minutes</h4><div class="val" id="total-min">0</div></div>
                </div>
                <h3>Historique Live</h3>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Machine</th><th>Start</th><th>Duree</th><th>Action</th></tr></thead>
                        <tbody id="live-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase (version CDN compatible)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // T-config dyalk
        const firebaseConfig = {
            apiKey: "AIzaSyASQa5cLXFllnV6EmYp-ARZ9dndWSKha6c",
            authDomain: "cvgmaroc-gmao.firebaseapp.com",
            projectId: "cvgmaroc-gmao",
            storageBucket: "cvgmaroc-gmao.firebasestorage.app",
            messagingSenderId: "72908747564",
            appId: "1:72908747564:web:82f646ef5dd209d03b7289"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "maintenance_logs");

        let currentData = [];
        let myChart = null;

        // Login Simple
        window.login = () => {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            if(p === "cvg2024") {
                window.currentUser = u;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('user-tag').innerText = "User: " + u;
                initRealtime();
            } else { alert("Pass incorrect !"); }
        };

        // Realtime Sync (Hadchi lli kidir cominixion bin pc o tel)
        function initRealtime() {
            const q = query(colRef, orderBy("server_ts", "desc"));
            onSnapshot(q, (snapshot) => {
                currentData = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderUI();
            });
        }

        // Add Incident
        window.addIncident = async () => {
            const p = document.getElementById('proj').value;
            const m = document.getElementById('mach').value;
            const s = document.getElementById('start-time').value;
            if(!p || !m || !s) return alert("Kamal l-ma3loumat!");

            await addDoc(colRef, {
                proj: p, mach: m, start: s, end: "-", dur: 0,
                status: "PENDING", user: window.currentUser,
                server_ts: serverTimestamp(),
                created_at: Date.now()
            });
            document.getElementById('start-time').value = "";
        };

        // Render UI
        function renderUI() {
            const table = document.getElementById('live-table');
            let total = 0;
            let pending = false;

            table.innerHTML = currentData.map(item => {
                total += item.dur;
                if(item.status === "PENDING") pending = true;
                return `
                    <tr>
                        <td><b>${item.mach}</b><br><small>${item.proj}</small></td>
                        <td>${item.start}</td>
                        <td><span class="status ${item.status === 'DONE' ? 'done' : 'pending'}">${item.dur} min</span></td>
                        <td>
                            ${item.status === 'PENDING' ? `<button onclick="openModal('${item.id}')" style="background:var(--accent); border:none; padding:5px; border-radius:5px; cursor:pointer;">FINIR</button>` : '✅'}
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('count').innerText = currentData.length;
            document.getElementById('total-min').innerText = total;
            document.getElementById('alarm').style.display = pending ? 'block' : 'none';
            updateChart(currentData);
        }

        // Modal Control
        window.openModal = (id) => {
            document.getElementById('m-id').value = id;
            document.getElementById('modal').style.display = 'flex';
        };

        window.saveClose = async () => {
            const id = document.getElementById('m-id').value;
            const end = document.getElementById('m-end').value;
            const prob = document.getElementById('m-prob').value;
            const sol = document.getElementById('m-sol').value;

            const item = currentData.find(x => x.id === id);
            const [sH, sM] = item.start.split(':').map(Number);
            const [eH, eM] = end.split(':').map(Number);
            let d = (eH * 60 + eM) - (sH * 60 + sM);
            if(d < 0) d += 1440;

            await updateDoc(doc(db, "maintenance_logs", id), {
                end: end, dur: d, prob: prob, sol: sol, status: "DONE"
            });
            document.getElementById('modal').style.display = 'none';
        };

        // Utils
        window.updateMach = () => {
            const m = { "SKODA": ["80008172", "80008173"], "CRAFTER": ["80008119", "80008122"] };
            const p = document.getElementById('proj').value;
            const s = document.getElementById('mach');
            s.innerHTML = m[p] ? m[p].map(x => `<option value="${x}">${x}</option>`).join('') : '<option>-- Machine --</option>';
        };

        function updateChart(data) {
            const ctx = document.getElementById('myChart').getContext('2d');
            const stats = { "SKODA": 0, "CRAFTER": 0 };
            data.forEach(x => { if(stats.hasOwnProperty(x.proj)) stats[x.proj] += x.dur; });

            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats),
                    datasets: [{ label: 'Min Perdues', data: Object.values(stats), backgroundColor: ['#002b5c', '#00d4ff'] }]
                },
                options: { maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
