<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CVG GMAO - Time Tracking</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #002b5c; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b; --bg: #f1f5f9; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; }
        .container { width: 100%; max-width: 450px; }
        
        #login-screen { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        input[type="password"] { width: 100%; padding: 15px; border-radius: 10px; border: 2px solid #e2e8f0; font-size: 1.2rem; text-align: center; margin-bottom: 20px; }
        .btn-login { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; }

        #app-screen { display: none; width: 100%; }
        header { background: var(--primary); color: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0; font-size: 16px; margin-bottom: 15px; }
        .btn-stop { width: 100%; padding: 18px; background: var(--danger); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem; cursor: pointer; }
        
        .notif-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 8px solid; }
        .status-open { border-left-color: var(--danger); }
        .status-closed { border-left-color: var(--success); opacity: 0.8; }
        
        .btn-start { background: var(--success); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .duration { font-size: 0.8rem; font-weight: bold; color: var(--primary); background: #e0f2fe; padding: 2px 8px; border-radius: 4px; }
        .hidden { display: none !important; }
    </style>
</head>
<body onclick="enableAudio()">

    <div class="container">
        <div id="login-screen">
            <div style="font-size:1.5rem; font-weight:800; color:var(--primary); margin-bottom:20px;">CVG GMAO</div>
            <input type="password" id="pinCode" placeholder="Code PIN" maxlength="4">
            <button class="btn-login" onclick="checkLogin()">CONNEXION</button>
        </div>

        <div id="app-screen">
            <header>
                <h3 id="userTitle">Interface</h3>
                <button onclick="location.reload()" style="background:none; border:none; color:white;"><i class="fas fa-sign-out-alt"></i></button>
            </header>

            <div id="operator-view" class="card hidden">
                <label>Machine</label>
                <select id="machineSelect">
                    <option value="KOMAX-01">KOMAX 01</option>
                    <option value="SCHUNK-04">SCHUNK 04</option>
                    <option value="BAN-TEST-02">BANC TEST 02</option>
                </select>
                <label>Probl√®me</label>
                <select id="panneType">
                    <option value="M√©canique">üîß M√©canique</option>
                    <option value="√âlectrique">‚ö° √âlectrique</option>
                </select>
                <button class="btn-stop" onclick="startArret()">üõë STOP MACHINE (ARRET)</button>
            </div>

            <div id="tech-view" class="hidden">
                <div id="notifList"></div>
            </div>
        </div>
    </div>

    <audio id="alertSound" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyASQa5cLXFllnV6EmYp-ARZ9dndWSKha6c",
            authDomain: "cvgmaroc-gmao.firebaseapp.com",
            databaseURL: "https://cvgmaroc-gmao-default-rtdb.firebaseio.com",
            projectId: "cvgmaroc-gmao",
            storageBucket: "cvgmaroc-gmao.firebasestorage.app",
            messagingSenderId: "72908747564",
            appId: "1:72908747564:web:82f646ef5dd209d03b7289"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const sound = document.getElementById('alertSound');
        let audioEnabled = false;

        function enableAudio() { audioEnabled = true; }

        function checkLogin() {
            const pin = document.getElementById('pinCode').value;
            if (pin === "1111") { showApp("operator-view", "Op√©rateur"); }
            else if (pin === "2222") { showApp("tech-view", "Maintenance"); startTechListener(); }
            else { alert("PIN Incorrect"); }
        }

        function showApp(viewId, title) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').style.display = 'block';
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById('userTitle').innerText = title;
        }

        // --- L'Op√©rateur clike sur STOP ---
        function startArret() {
            const machine = document.getElementById('machineSelect').value;
            const type = document.getElementById('panneType').value;
            const startTime = Date.now(); // Temps en millisecondes
            
            database.ref('pannes/').push({
                machine: machine,
                type: type,
                startTime: startTime,
                startTimeStr: new Date(startTime).toLocaleTimeString('fr-FR'),
                status: 'OPEN',
                duration: ''
            }).then(() => alert("Machine Arr√™t√©e ! Alerte envoy√©e."));
        }

        // --- Le Technicien clike sur START (Sali l'islah) ---
        function stopArret(key, startTime) {
            const endTime = Date.now();
            const diffMs = endTime - startTime;
            const diffMins = Math.round(diffMs / 60000); // Convertir en minutes

            database.ref('pannes/' + key).update({
                status: 'CLOSED',
                endTimeStr: new Date(endTime).toLocaleTimeString('fr-FR'),
                duration: diffMins + " min"
            });
        }

        function startTechListener() {
            database.ref('pannes/').on('value', (snapshot) => {
                const data = snapshot.val();
                const container = document.getElementById('notifList');
                container.innerHTML = "";
                let hasAlert = false;

                if (data) {
                    Object.keys(data).reverse().forEach(key => {
                        const p = data[key];
                        const isClosed = p.status === 'CLOSED';
                        if(!isClosed) hasAlert = true;

                        container.innerHTML += `
                            <div class="notif-item ${isClosed ? 'status-closed' : 'status-open'}">
                                <div>
                                    <b>${p.machine}</b> ${isClosed ? '‚úÖ' : 'üö®'}<br>
                                    <small>${p.type} | Stop: ${p.startTimeStr}</small><br>
                                    ${isClosed ? `<span class="duration">Dur√©e: ${p.duration}</span>` : ''}
                                </div>
                                ${!isClosed ? `<button class="btn-start" onclick="stopArret('${key}', ${p.startTime})">‚öôÔ∏è START (FIN)</button>` : ''}
                            </div>`;
                    });
                }
                
                if (hasAlert) { if(audioEnabled) sound.play(); navigator.vibrate([500,200,500]); } 
                else { sound.pause(); }
            });
        }
    </script>
</body>
</html>
