<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVG | Maintenance Pro-Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        :root {
            --primary: #002b5c;
            --accent: #00d4ff;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: #1e293b; padding: 20px; }

        .alert-marquee {
            background: #fee2e2; color: #ef4444; padding: 12px; border-radius: 12px;
            margin-bottom: 20px; font-weight: 800; border: 2px solid #ef4444;
            display: none; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .blink-danger { animation: blinker 0.6s linear infinite; background-color: var(--danger) !important; color: white !important; }
        @keyframes blinker { 50% { opacity: 0.2; } }

        #toast {
            position: fixed; top: 20px; right: 20px; 
            background: var(--success); color: white; padding: 15px 25px;
            border-radius: 12px; font-weight: 800; box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            display: none; z-index: 10000; animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        #closeModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 20000;
            display: none; justify-content: center; align-items: center; padding: 20px;
            backdrop-filter: blur(5px);
        }

        #pro-analytics-overlay {
            position: fixed; inset: 0; background: #f0f2f5; z-index: 10001;
            display: none; padding: 40px; overflow-y: auto;
        }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-top: 20px; }
        .chart-container-pro { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); height: 400px; }

        #login-overlay {
            position: fixed; inset: 0; 
            background: radial-gradient(circle at top right, #003a7d, #001a38);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }

        .login-box { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
            padding: 50px 40px; border-radius: 30px; width: 420px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); text-align: center;
        }

        .login-box input { width: 100%; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0; margin-bottom: 15px; outline: none; }
        .btn-login { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; }

        .container { max-width: 1500px; margin: 0 auto; display: none; }
        header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 25px; }

        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background: var(--card); padding: 20px; border-radius: 20px; border-left: 5px solid var(--primary); }
        .kpi-card h3 { font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        .kpi-card .val { font-size: 1.5rem; font-weight: 800; color: var(--primary); }

        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 25px; }
        .panel { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 12px; text-align: left; font-size: 0.75rem; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #edf2f7; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }
        
        .col-mochkil { color: #ef4444; font-weight: 600; font-size: 0.8rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .col-l7al { color: #10b981; font-weight: 600; font-size: 0.8rem; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .badge { padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.7rem; }
        .badge-red { background: #fee2e2; color: #ef4444; }
        .badge-green { background: #dcfce7; color: #10b981; }
        .btn-finish { padding: 6px 12px; background: var(--accent); color: var(--primary); border: none; border-radius: 8px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>

    <div id="closeModal">
        <div class="panel" style="width:100%; max-width:450px; border-top: 5px solid var(--accent);">
            <h3 style="margin-bottom:20px;"><i class="fa-solid fa-file-signature"></i> D√©tails de Cl√¥ture</h3>
            <input type="hidden" id="modal-id">
            
            <div style="margin-bottom: 15px;">
                <label style="font-size: 0.8rem; font-weight: 700;">TYPE D'ARR√äT</label>
                <select id="modal-type" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
                    <option value="M√©canique">üîß M√©canique</option>
                    <option value="√âlectrique">‚ö° √âlectrique</option>
                    <option value="Process">‚öôÔ∏è Process</option>
                    <option value="Logistique">üì¶ Logistique</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-size: 0.8rem; font-weight: 700;">MOCHKIL (Probl√®me)</label>
                <input type="text" id="modal-prob" placeholder="Ex: Capteur HS" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-size: 0.8rem; font-weight: 700;">L7AL (Solution)</label>
                <input type="text" id="modal-action" placeholder="Ex: Changement Capteur" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-size: 0.8rem; font-weight: 700;">HEURE DE FIN</label>
                <input type="text" id="modal-end" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn-login" style="background:var(--success)" onclick="confirmClosing()">VALIDER</button>
                <button class="btn-login" style="background:#64748b" onclick="document.getElementById('closeModal').style.display='none'">ANNULER</button>
            </div>
        </div>
    </div>

    <div id="toast">‚úÖ Arr√™t ouvert avec succ√®s !</div>

    <div id="login-overlay">
        <div class="login-box">
            <h2>CVG MAINTENANCE</h2>
            <p style="margin-bottom: 20px; color: #64748b;">Syst√®me de gestion des pannes</p>
            <input type="text" id="u-name" placeholder="Utilisateur">
            <input type="password" id="u-pass" placeholder="Mot de passe">
            <button class="btn-login" onclick="handleLogin()">SE CONNECTER</button>
        </div>
    </div>

    <div class="container" id="app-content">
        <header>
            <h1>CVG <span style="color:var(--accent)">DYNAMICS</span></h1>
            <div style="display:flex; gap:10px;">
                <button class="btn-finish" onclick="openProDashboard()">DASHBOARD</button>
                <button onclick="location.reload()" style="background:var(--danger); color:white; border:none; padding:10px; border-radius:10px; cursor:pointer;">D√©connexion</button>
            </div>
        </header>

        <div id="dynamic-alert-box" class="alert-marquee"></div>

        <div class="kpi-grid">
            <div class="kpi-card"><h3>Nombre d'Arr√™ts</h3><div class="val" id="kpi-count">0</div></div>
            <div class="kpi-card"><h3>Temps Perdu</h3><div class="val" id="kpi-total">0 min</div></div>
            <div class="kpi-card"><h3>MTTR</h3><div class="val" id="kpi-mttr">0</div></div>
            <div class="kpi-card"><h3>Disponibilit√©</h3><div class="val" id="kpi-avail">100%</div></div>
        </div>

        <div class="main-layout">
            <div class="panel">
                <h3 style="margin-bottom:15px;">Nouvel Incident</h3>
                <select id="in-proj" onchange="updateMachines()" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd;">
                    <option value="">-- Projet --</option>
                    <option value="SKODA">SKODA</option>
                    <option value="CRAFTER">CRAFTER</option>
                    <option value="G.CALIFORNIA">G.CALIFORNIA</option>
                </select>
                <select id="in-mach" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd;">
                    <option value="">-- Machine --</option>
                </select>
                <input type="text" id="in-START" placeholder="START (Ex: 08:30)" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd;">
                <button class="btn-login" onclick="submitEntry()">OUVRIR L'ARR√äT</button>
                
                <div style="margin-top:20px; height:200px;">
                    <canvas id="factoryChart"></canvas>
                </div>
            </div>

            <div class="panel">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>Historique Maintenance</h3>
                    <input type="text" id="searchTable" placeholder="Rechercher machine..." onkeyup="filterTable()" style="padding:8px; border-radius:8px; border:1px solid #ddd; width:200px;">
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>DATE</th>
                                <th>MACHINE</th>
                                <th>TYPE</th>
                                <th>MOCHKIL</th>
                                <th>L7AL</th>
                                <th>DUR√âE</th>
                                <th>SHIFT</th>
                                <th>ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="data-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="pro-analytics-overlay">
        <button class="btn-login" style="width:auto; float:right;" onclick="document.getElementById('pro-analytics-overlay').style.display='none'">FERMER</button>
        <h2 style="margin-bottom:30px;">Statistiques de Performance</h2>
        <div class="stats-grid">
            <div class="chart-container-pro"><canvas id="chartShiftPro"></canvas></div>
            <div class="chart-container-pro"><canvas id="chartTypesPro"></canvas></div>
        </div>
    </div>

    <script>
        const machineData = { "SKODA": ["80008172", "80008173", "80008174"], "CRAFTER": ["80008119", "80008122", "80008116"], "G.CALIFORNIA": ["80006953"] };
        let db = JSON.parse(localStorage.getItem('cvg_pro_db')) || [];
        let activeUser = null;
        let chartObj = null;

        function updateMachines() {
            const proj = document.getElementById('in-proj').value;
            const machSelect = document.getElementById('in-mach');
            machSelect.innerHTML = '<option value="">-- Machine --</option>';
            if(proj) machineData[proj].forEach(m => { machSelect.innerHTML += `<option value="${m}">${m}</option>`; });
        }

        function handleLogin() {
            const u = document.getElementById('u-name').value;
            const p = document.getElementById('u-pass').value;
            if(u === "admin" && p === "cvg2024") {
                activeUser = {u, role: "admin"};
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                refreshUI();
            } else { alert("Erreur !"); }
        }

        function submitEntry() {
            const p = document.getElementById('in-proj').value;
            const m = document.getElementById('in-mach').value;
            const s = document.getElementById('in-START').value;
            if(!p || !m || !s) return alert("Remplir tout !");
            
            db.unshift({ 
                id: Date.now(), ts: new Date().toLocaleDateString('fr-FR'), 
                proj: p, mach: m, START: s, END: "-", dur: 0, 
                SHIFT: "-", status: "PENDING", type: "", prob: "", action: "" 
            });
            localStorage.setItem('cvg_pro_db', JSON.stringify(db));
            refreshUI();
            document.getElementById('toast').style.display = 'block';
            setTimeout(() => { document.getElementById('toast').style.display = 'none'; }, 2000);
        }

        function closeIncident(id) {
            document.getElementById('modal-id').value = id;
            const now = new Date();
            document.getElementById('modal-end').value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            document.getElementById('closeModal').style.display = 'flex';
        }

        function confirmClosing() {
            const id = parseInt(document.getElementById('modal-id').value);
            const endH = document.getElementById('modal-end').value;
            const type = document.getElementById('modal-type').value;
            const prob = document.getElementById('modal-prob').value;
            const act = document.getElementById('modal-action').value;

            if(!endH || !prob || !act) return alert("Remplir tout !");

            const idx = db.findIndex(x => x.id === id);
            if(idx !== -1) {
                const [sH, sM] = db[idx].START.split(':').map(Number);
                const [eH, eM] = endH.split(':').map(Number);
                let diff = (eH * 60 + eM) - (sH * 60 + sM);
                if(diff < 0) diff += 1440;

                db[idx].END = endH;
                db[idx].dur = diff;
                db[idx].status = "DONE";
                db[idx].type = type;
                db[idx].prob = prob;
                db[idx].action = act;
                db[idx].SHIFT = (eH >= 6 && eH < 14) ? "MATIN" : (eH >= 14 && eH < 22) ? "SOIR" : "NUIT";

                localStorage.setItem('cvg_pro_db', JSON.stringify(db));
                document.getElementById('closeModal').style.display = 'none';
                refreshUI();
            }
        }

        function refreshUI() {
            const table = document.getElementById('data-table');
            table.innerHTML = db.map(x => `
                <tr>
                    <td>${x.ts}</td>
                    <td><b>${x.mach}</b></td>
                    <td>${x.type || '-'}</td>
                    <td class="col-mochkil" title="${x.prob}">${x.prob || '-'}</td>
                    <td class="col-l7al" title="${x.action}">${x.action || '-'}</td>
                    <td><span class="badge ${x.status==='DONE'?'badge-green':'badge-red'}">${x.dur} min</span></td>
                    <td>${x.SHIFT}</td>
                    <td>
                        ${x.status==='PENDING' ? `<button class="btn-finish" onclick="closeIncident(${x.id})">FINIR</button>` : '‚úÖ'}
                    </td>
                </tr>`).join('');
            
            const total = db.reduce((a,b) => a + b.dur, 0);
            document.getElementById('kpi-count').innerText = db.length;
            document.getElementById('kpi-total').innerText = total + " min";
            updateChart();
        }

        function filterTable() {
            const val = document.getElementById('searchTable').value.toUpperCase();
            const rows = document.getElementById('data-table').getElementsByTagName('tr');
            for (let row of rows) { row.style.display = row.innerText.toUpperCase().includes(val) ? "" : "none"; }
        }

        function updateChart() {
            const factoryData = { "SKODA": 0, "CRAFTER": 0, "G.CALIFORNIA": 0 };
            db.forEach(x => { if(factoryData.hasOwnProperty(x.proj)) factoryData[x.proj] += x.dur; });
            const ctx = document.getElementById('factoryChart').getContext('2d');
            if(chartObj) chartObj.destroy();
            chartObj = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(factoryData), datasets: [{ label: 'Min', data: Object.values(factoryData), backgroundColor: '#00d4ff' }] }, options: { maintainAspectRatio: false } });
        }

        function openProDashboard() {
            document.getElementById('pro-analytics-overlay').style.display = 'block';
            // Simple logic for pie charts based on types and shifts
        }
    </script>
</body>
</html>
