<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CVG DYNAMICS PRO | Analytics Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --primary: #002b5c; --accent: #00d4ff; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --bg: #f8fafc; --purple: #8b5cf6; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); padding: 10px; }

        header { background: var(--primary); color: white; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        .grid-kpi { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: white; padding: 15px; border-radius: 15px; border-left: 5px solid var(--accent); position: relative; overflow: hidden; transition: 0.3s; }
        .kpi-card i { position: absolute; right: 10px; bottom: 10px; opacity: 0.1; font-size: 2rem; }
        .kpi-card span { display: block; font-size: 0.7rem; color: #64748b; font-weight: 800; text-transform: uppercase; }
        .kpi-card b { font-size: 1.2rem; color: var(--primary); }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-pdf { background: #1e293b; color: white; margin-top: 10px; }
        .btn-stop { background: var(--danger); color: white; }
        
        .alert-blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }

        select, input { width: 100%; padding: 12px; border-radius: 10px; border: 1.5px solid #e2e8f0; margin-bottom: 10px; outline: none; background: #fff; }
        .hidden { display: none !important; }
        #closeModal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 10000; padding: 20px; backdrop-filter: blur(4px); }
    </style>
</head>
<body onclick="enableAudio()">

    <div id="login-overlay" style="position:fixed; inset:0; background:radial-gradient(circle at top right, var(--primary), #001a38); z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:40px 30px; border-radius:25px; width:340px; text-align:center; box-shadow: 0 20px 40px rgba(0,0,0,0.4);">
            <div style="background:var(--primary); width:60px; height:60px; border-radius:15px; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; color:white;">
                <i class="fas fa-tools fa-2x"></i>
            </div>
            <h2 style="color:var(--primary); font-weight:800;">CVG GMAO</h2>
            <input type="password" id="pinInput" placeholder="PIN CODE" maxlength="4" style="margin-top:20px; text-align:center; font-size:1.8rem; letter-spacing:10px; border:2px solid #eee;">
            <button class="btn btn-stop" style="background:var(--primary)" onclick="checkLogin()">IDENTIFICATION</button>
            <div style="margin-top:15px; font-size:0.6rem; color:#94a3b8;">OP: 1111 | TECH: 2222 | MGR: 3333</div>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <header>
            <div><small id="roleText" style="opacity:0.8; font-weight:bold;"></small><h2 style="font-size:1.1rem;">CVG <span style="color:var(--accent)">DYNAMICS</span></h2></div>
            <button onclick="location.reload()" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:8px; border-radius:10px;"><i class="fas fa-power-off"></i></button>
        </header>

        <div id="manager-panel" class="hidden">
            <div class="grid-kpi">
                <div class="kpi-card" id="card-pannes"><span>Total Pannes</span><b id="m-count">0</b><i class="fas fa-exclamation-triangle"></i></div>
                <div class="kpi-card" id="card-time" style="border-left-color: var(--danger);"><span>Downtime (Min)</span><b id="m-time">0</b><i class="fas fa-clock"></i></div>
                <div class="kpi-card" id="card-mtbf" style="border-left-color: var(--success);"><span>MTBF (Moy)</span><b id="m-mtbf">0</b><i class="fas fa-chart-line"></i></div>
                <div class="kpi-card" id="card-mttr" style="border-left-color: var(--purple);"><span>MTTR (R√©par.)</span><b id="m-mttr">0</b><i class="fas fa-tools"></i></div>
            </div>
            <div class="card">
                <canvas id="managerChart"></canvas>
            </div>
            <button class="btn btn-pdf" onclick="generateDailyPDF()"><i class="fas fa-file-pdf"></i> EXPORT RAPPORT PERFORMANCE</button>
        </div>

        <div id="op-panel" class="card hidden">
            <label>S√©lectionnez Projet</label>
            <select id="in-proj" onchange="updateMachineList()"><option value="SKODA">SKODA</option><option value="CRAFTER">CRAFTER</option><option value="G.CALIFORNIA">G.CALIFORNIA</option></select>
            <label>S√©lectionnez Machine</label>
            <select id="in-mach"></select>
            <button class="btn btn-stop" onclick="openArret()"><i class="fas fa-bell"></i> SIGNALER ARR√äT</button>
        </div>

        <div class="card" style="padding:10px;">
            <h4 style="margin:10px; font-size:0.9rem; color:var(--primary);"><i class="fas fa-stream"></i> √âTAT DES MACHINES</h4>
            <div id="pannes-list"></div>
        </div>
    </div>

    <div id="closeModal">
        <div style="background:white; padding:30px; border-radius:25px; width:100%; max-width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
            <h3 style="color:var(--primary); margin-bottom:20px;">Reprise d'Activit√©</h3>
            <input type="hidden" id="modal-key">
            <label>Type d'Intervention</label>
            <select id="modal-type"><option>üîß M√©canique</option><option>‚ö° √âlectrique</option><option>‚öôÔ∏è Process</option><option>üì¶ Logistique</option></select>
            <label>Pi√®ce de Rechange</label>
            <input type="text" id="modal-piece" placeholder="Nom de la pi√®ce ou N/A">
            <button class="btn btn-stop" style="background:var(--success)" onclick="confirmClosing()">D√âMARRER MACHINE</button>
            <button onclick="document.getElementById('closeModal').style.display='none'" style="width:100%; margin-top:10px; background:none; border:none; color:grey;">Annuler</button>
        </div>
    </div>

    <audio id="alertSound" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const machineData = { "SKODA": ["80008172", "80008173", "80008174"], "CRAFTER": ["80008119", "80008122", "80008116"], "G.CALIFORNIA": ["80006953"] };
        const firebaseConfig = {
            apiKey: "AIzaSyASQa5cLXFllnV6EmYp-ARZ9dndWSKha6c",
            authDomain: "cvgmaroc-gmao.firebaseapp.com",
            databaseURL: "https://cvgmaroc-gmao-default-rtdb.firebaseio.com",
            projectId: "cvgmaroc-gmao",
            storageBucket: "cvgmaroc-gmao.firebasestorage.app",
            messagingSenderId: "72908747564",
            appId: "1:72908747564:web:82f646ef5dd209d03b7289"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let currentUser = null; let myChart = null; let allData = [];

        function enableAudio() { window.audioAllowed = true; }

        function checkLogin() {
            const pin = document.getElementById('pinInput').value;
            if(pin === "1111") currentUser = "OPERATEUR";
            else if(pin === "2222") currentUser = "MAINTENANCE";
            else if(pin === "3333") currentUser = "MANAGER";
            else return alert("Code PIN Incorrect");
            
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('roleText').innerText = "MODE " + currentUser;
            if(currentUser === "OPERATEUR") { document.getElementById('op-panel').classList.remove('hidden'); updateMachineList(); }
            if(currentUser === "MANAGER") document.getElementById('manager-panel').classList.remove('hidden');
            listenFirebase();
        }

        function updateMachineList() {
            const proj = document.getElementById('in-proj').value;
            const select = document.getElementById('in-mach');
            select.innerHTML = "";
            machineData[proj].forEach(m => select.innerHTML += `<option value="${m}">${m}</option>`);
        }

        function openArret() {
            const proj = document.getElementById('in-proj').value;
            const mach = document.getElementById('in-mach').value;
            database.ref('pannes/').push({
                proj: proj, mach: mach,
                startTs: Date.now(),
                startStr: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}),
                dateStr: new Date().toLocaleDateString('fr-FR'),
                status: 'OPEN',
                piece: '-'
            }).then(() => alert("üî¥ SIGNAL ENVOY√â √Ä LA MAINTENANCE"));
        }

        function listenFirebase() {
            database.ref('pannes/').on('value', snap => {
                const data = snap.val();
                allData = data ? Object.entries(data).map(([key, val]) => ({key, ...val})) : [];
                renderUI();
                if(currentUser === "MANAGER") updateManagerDashboard();
            });
        }

        function renderUI() {
            const container = document.getElementById('pannes-list');
            container.innerHTML = "";
            let alertActive = false;

            allData.slice().reverse().forEach(p => {
                const isOpen = p.status === 'OPEN';
                if(isOpen) alertActive = true;
                container.innerHTML += `
                    <div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; background:${isOpen ? '#fff5f5' : 'transparent'}">
                        <div>
                            <b style="color:var(--primary)">${p.mach}</b> <span style="font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:5px;">${p.proj}</span><br>
                            <small style="color:#64748b">${p.startStr} | ${isOpen ? '<b style="color:red">EN ARR√äT</b>' : p.duration+' min | ‚öôÔ∏è '+p.piece}</small>
                        </div>
                        ${isOpen && currentUser === 'MAINTENANCE' ? 
                        `<button onclick="openModal('${p.key}')" style="background:var(--success); color:white; border:none; padding:10px 18px; border-radius:10px; font-weight:bold; cursor:pointer;">REPRIS</button>` : 
                        `<i class="fas ${isOpen ? 'fa-exclamation-circle' : 'fa-check-circle'}" style="color:${isOpen?'var(--danger)':'var(--success)'}; font-size:1.2rem;"></i>`}
                    </div>
                `;
            });

            if(alertActive && currentUser === "MAINTENANCE") {
                if(window.audioAllowed) document.getElementById('alertSound').play();
                if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
            } else { document.getElementById('alertSound').pause(); }
        }

        function openModal(key) { document.getElementById('modal-key').value = key; document.getElementById('closeModal').style.display = 'flex'; }

        function confirmClosing() {
            const key = document.getElementById('modal-key').value;
            const item = allData.find(x => x.key === key);
            const duration = Math.round((Date.now() - item.startTs) / 60000);
            database.ref('pannes/' + key).update({
                status: 'CLOSED',
                duration: duration,
                type: document.getElementById('modal-type').value,
                piece: document.getElementById('modal-piece').value || 'Aucune'
            }).then(() => document.getElementById('closeModal').style.display = 'none');
        }

        function updateManagerDashboard() {
            const stats = { "SKODA": 0, "CRAFTER": 0, "G.CALIFORNIA": 0 };
            let totalDowntime = 0;
            const tempsProductionTotal = 1440; // 24h en min

            allData.forEach(p => { 
                if(p.duration) { 
                    stats[p.proj] += p.duration; 
                    totalDowntime += p.duration; 
                }
            });

            const nbPannes = allData.length;
            const mtbf = nbPannes > 0 ? Math.round((tempsProductionTotal - totalDowntime) / nbPannes) : tempsProductionTotal;
            const mttr = nbPannes > 0 ? Math.round(totalDowntime / nbPannes) : 0;

            // Affichage des valeurs
            document.getElementById('m-count').innerText = nbPannes;
            document.getElementById('m-time').innerText = totalDowntime + " min";
            document.getElementById('m-mtbf').innerText = mtbf + " min";
            document.getElementById('m-mttr').innerText = mttr + " min";

            // Alerte Visuelle MTTR > 1 min
            const mttrCard = document.getElementById('card-mttr');
            const mttrVal = document.getElementById('m-mttr');
            if(mttr > 1) {
                mttrCard.style.borderLeftColor = "var(--danger)";
                mttrVal.style.color = "var(--danger)";
                mttrVal.classList.add('alert-blink');
            } else {
                mttrCard.style.borderLeftColor = "var(--purple)";
                mttrVal.style.color = "var(--primary)";
                mttrVal.classList.remove('alert-blink');
            }

            const ctx = document.getElementById('managerChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: Object.keys(stats), 
                    datasets: [{ data: Object.values(stats), backgroundColor: ['#002b5c', '#00d4ff', '#10b981'] }] 
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        function generateDailyPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18); doc.setTextColor(0, 43, 92);
            doc.text("RAPPORT PERFORMANCE GMAO - CVG", 15, 20);
            
            doc.setFontSize(11); doc.setTextColor(50);
            const summary = `Pannes: ${allData.length} | Downtime: ${document.getElementById('m-time').innerText} | MTBF: ${document.getElementById('m-mtbf').innerText} | MTTR: ${document.getElementById('m-mttr').innerText}`;
            doc.text(summary, 15, 30);

            doc.setFontSize(10); doc.setTextColor(100);
            doc.text("G√©n√©r√© le: " + new Date().toLocaleString(), 15, 38);
            
            const rows = allData.map(p => [p.dateStr, p.mach, p.proj, p.startStr, p.duration || '0', p.type || '-', p.piece]);
            doc.autoTable({
                head: [['Date', 'Machine', 'Projet', 'Heure', 'Dur√©e(m)', 'Type', 'Pi√®ce']],
                body: rows,
                startY: 45,
                theme: 'striped',
                headStyles: { fillColor: [0, 43, 92] }
            });
            doc.save(`Performance_CVG_${new Date().toLocaleDateString()}.pdf`);
        }
    </script>
</body>
</html>
