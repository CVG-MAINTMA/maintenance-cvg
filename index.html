<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CVG DYNAMICS | Cloud GMAO</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --primary: #002b5c; --accent: #00d4ff; --success: #10b981; --danger: #ef4444; --bg: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); padding: 15px; }

        /* Login */
        #login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 320px; text-align: center; color: #333; }
        
        /* Layout */
        header { background: white; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: white; padding: 15px; border-radius: 15px; border-bottom: 4px solid var(--primary); text-align: center; }
        .kpi-card .val { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        
        .main-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn-stop { width: 100%; padding: 15px; background: var(--danger); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1rem; cursor: pointer; }
        
        /* Table */
        .table-container { background: white; border-radius: 15px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { background: #f1f5f9; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .status-open { color: var(--danger); font-weight: 800; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        .btn-finish { background: var(--success); color: white; border: none; padding: 5px 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; }

        /* Modal Cl√¥ture */
        #closeModal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 10000; padding: 20px; }
    </style>
</head>
<body onclick="enableAudio()">

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--primary)">CVG GMAO</h2>
            <p style="font-size: 0.8rem; margin-bottom: 20px;">Entrez votre code PIN</p>
            <input type="password" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:12px; text-align:center; font-size:1.5rem; border-radius:10px; border:2px solid #ddd; margin-bottom:20px;">
            <button class="btn-stop" style="background:var(--primary)" onclick="checkLogin()">D√âMARRER</button>
        </div>
    </div>

    <div id="closeModal">
        <div style="background:white; padding:25px; border-radius:20px; width:100%; max-width:400px;">
            <h3 style="margin-bottom:15px; color:var(--primary)">Cl√¥turer l'Arr√™t</h3>
            <input type="hidden" id="modal-key">
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:bold;">Type de Panne:</label>
                <select id="modal-type" style="width:100%; padding:10px; margin-top:5px; border-radius:8px;">
                    <option value="M√©canique">üîß M√©canique</option>
                    <option value="√âlectrique">‚ö° √âlectrique</option>
                    <option value="Process">‚öôÔ∏è Process</option>
                </select>
            </div>
            <button class="btn-stop" style="background:var(--success)" onclick="confirmClosing()">CONFIRMER START MACHINE</button>
            <button onclick="document.getElementById('closeModal').style.display='none'" style="width:100%; margin-top:10px; background:none; border:none; color:#666;">Annuler</button>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <header>
            <h2 style="font-size:1rem; color:var(--primary)">CVG <span style="color:var(--accent)">DYNAMICS</span></h2>
            <div id="roleBadge" style="font-size:0.7rem; background:#eee; padding:5px 10px; border-radius:10px; font-weight:800;"></div>
        </header>

        <div class="kpi-grid">
            <div class="kpi-card"><h3>Arr√™ts</h3><div class="val" id="kpi-count">0</div></div>
            <div class="kpi-card"><h3>Downtime</h3><div class="val" id="kpi-total">0 min</div></div>
        </div>

        <div id="op-panel" class="main-card hidden">
            <h4 style="margin-bottom:15px;">Signaler un Arr√™t (STOP)</h4>
            <select id="in-proj" style="width:100%; padding:12px; border-radius:10px; margin-bottom:10px;">
                <option value="SKODA">SKODA</option>
                <option value="CRAFTER">CRAFTER</option>
                <option value="G.CALIFORNIA">G.CALIFORNIA</option>
            </select>
            <input type="text" id="in-mach" placeholder="Machine (Ex: 80008172)" style="width:100%; padding:12px; border-radius:10px; margin-bottom:15px; border:1px solid #ddd;">
            <button class="btn-stop" onclick="openArret()">üõë STOP MACHINE</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Machine</th><th>Start</th><th>Duree</th><th>Status</th></tr>
                </thead>
                <tbody id="data-table"></tbody>
            </table>
        </div>
    </div>

    <audio id="alertSound" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyASQa5cLXFllnV6EmYp-ARZ9dndWSKha6c",
            authDomain: "cvgmaroc-gmao.firebaseapp.com",
            databaseURL: "https://cvgmaroc-gmao-default-rtdb.firebaseio.com",
            projectId: "cvgmaroc-gmao",
            storageBucket: "cvgmaroc-gmao.firebasestorage.app",
            messagingSenderId: "72908747564",
            appId: "1:72908747564:web:82f646ef5dd209d03b7289"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let currentUser = null;
        let audioActive = false;
        const sound = document.getElementById('alertSound');

        function enableAudio() { audioActive = true; }

        function checkLogin() {
            const pin = document.getElementById('pinInput').value;
            if(pin === "1111") { currentUser = {role: 'OPERATEUR'}; loadApp(); }
            else if(pin === "2222") { currentUser = {role: 'MAINTENANCE'}; loadApp(); }
            else { alert("PIN Erron√©"); }
        }

        function loadApp() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('roleBadge').innerText = currentUser.role;
            if(currentUser.role === 'OPERATEUR') document.getElementById('op-panel').classList.remove('hidden');
            listenToFirebase();
        }

        function openArret() {
            const proj = document.getElementById('in-proj').value;
            const mach = document.getElementById('in-mach').value;
            if(!mach) return alert("Entrez le N¬∞ de machine");
            
            database.ref('pannes/').push({
                proj: proj,
                mach: mach,
                startTs: Date.now(),
                startStr: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}),
                status: 'OPEN',
                duration: 0
            }).then(() => { alert("Alerte envoy√©e !"); document.getElementById('in-mach').value = ""; });
        }

        function listenToFirebase() {
            database.ref('pannes/').on('value', (snapshot) => {
                const data = snapshot.val();
                const table = document.getElementById('data-table');
                table.innerHTML = "";
                let hasActiveAlert = false;
                let totalMin = 0;
                let count = 0;

                if(data) {
                    Object.keys(data).reverse().forEach(key => {
                        const p = data[key];
                        count++;
                        const isOpen = p.status === 'OPEN';
                        if(isOpen) hasActiveAlert = true;
                        if(p.duration) totalMin += p.duration;

                        table.innerHTML += `
                            <tr>
                                <td><b>${p.mach}</b><br><small>${p.proj}</small></td>
                                <td>${p.startStr}</td>
                                <td>${isOpen ? '...' : p.duration + ' min'}</td>
                                <td>
                                    ${isOpen && currentUser.role === 'MAINTENANCE' ? 
                                    `<button class="btn-finish" onclick="openModal('${key}')">START</button>` : 
                                    `<span class="${isOpen ? 'status-open' : ''}" style="color:${isOpen ? 'red' : 'green'}">${isOpen ? 'ARR√äT' : 'OK'}</span>`}
                                </td>
                            </tr>
                        `;
                    });
                }
                
                document.getElementById('kpi-count').innerText = count;
                document.getElementById('totalMin').innerText = totalMin + " min";

                // Alertes Sonores
                if(hasActiveAlert && currentUser.role === 'MAINTENANCE') {
                    if(audioActive) sound.play();
                    if(navigator.vibrate) navigator.vibrate([500,200,500]);
                } else {
                    sound.pause();
                }
            });
        }

        function openModal(key) {
            document.getElementById('modal-key').value = key;
            document.getElementById('closeModal').style.display = 'flex';
        }

        function confirmClosing() {
            const key = document.getElementById('modal-key').value;
            const type = document.getElementById('modal-type').value;
            
            database.ref('pannes/' + key).once('value').then(snap => {
                const startTs = snap.val().startTs;
                const duration = Math.round((Date.now() - startTs) / 60000);
                
                database.ref('pannes/' + key).update({
                    status: 'CLOSED',
                    duration: duration,
                    type: type
                }).then(() => {
                    document.getElementById('closeModal').style.display = 'none';
                });
            });
        }
    </script>
</body>
</html>
