<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVG | Multi-Role Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --primary: #001e3c; --accent: #00d4ff; --success: #10b981; --danger: #ef4444; --bg: #f3f6f9; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: #1e293b; }

        /* Login Styling */
        #login-screen { position: fixed; inset: 0; background: var(--primary); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 25px; width: 350px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .role-btn { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; cursor: pointer; font-weight: 800; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .role-btn:hover { border-color: var(--accent); background: #f0fbff; }

        /* Navigation */
        nav { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .badge-role { padding: 5px 15px; border-radius: 50px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }

        /* Sections Visibility */
        .app-section { display: none; padding: 25px; max-width: 1200px; margin: auto; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Cards */
        .glass-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); margin-bottom: 20px; border: 1px solid #edf2f7; }
        .btn-action { background: var(--primary); color: white; border: none; padding: 15px 25px; border-radius: 12px; font-weight: 800; cursor: pointer; width: 100%; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; border-left: 5px solid var(--accent); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="margin-bottom:20px;">Portail CVG</h2>
            <p style="color:#64748b; margin-bottom:20px;">Choisissez votre profil :</p>
            <button class="role-btn" onclick="initApp('OPERATEUR')"><i class="fas fa-hard-hat"></i> OPÉRATEUR</button>
            <button class="role-btn" onclick="initApp('MAINTENANCE')"><i class="fas fa-tools"></i> MAINTENANCE</button>
            <button class="role-btn" onclick="initApp('MANAGER')"><i class="fas fa-chart-line"></i> MANAGER</button>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <nav>
            <h2 style="color:var(--primary)">CVG <span style="color:var(--accent)">DYNAMICS</span></h2>
            <div style="display:flex; align-items:center; gap:15px;">
                <span id="role-display" class="badge-role"></span>
                <button onclick="location.reload()" style="background:none; border:none; cursor:pointer; color:var(--danger); font-weight:800;">Quitter</button>
            </div>
        </nav>

        <div id="sec-OPERATEUR" class="app-section">
            <div class="glass-card" style="text-align:center;">
                <h3 style="margin-bottom:20px;">Signaler un arrêt de machine</h3>
                <div style="margin-bottom:15px; text-align:left;">
                    <label>Machine / Poste</label>
                    <select id="op-mach" style="width:100%; padding:15px; border-radius:10px; margin-top:5px;">
                        <option>LINE-SKODA-01</option>
                        <option>LINE-CRAFTER-05</option>
                        <option>LINE-CALIF-02</option>
                    </select>
                </div>
                <button class="btn-action" style="background:var(--danger); height:100px; font-size:1.5rem;" onclick="createAlert()">
                    <i class="fas fa-exclamation-triangle"></i> SIGNALER PANNE
                </button>
            </div>
            <div class="glass-card">
                <h4>Mes alertes récentes</h4>
                <div id="op-history" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="sec-MAINTENANCE" class="app-section">
            <h3 style="margin-bottom:20px;">Interventions en attente</h3>
            <div id="maint-list"></div>
        </div>

        <div id="sec-MANAGER" class="app-section">
            <div class="stats-grid">
                <div class="stat-card"> <small>Disponibilité</small><h2 id="st-oee">98%</h2> </div>
                <div class="stat-card"> <small>MTTR (Moyen)</small><h2 id="st-mttr">0m</h2> </div>
                <div class="stat-card"> <small>Total Pannes</small><h2 id="st-count">0</h2> </div>
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
                <div class="glass-card">
                    <h3>Analyse des arrêts (Minutes)</h3>
                    <canvas id="managerChart" style="height:300px;"></canvas>
                </div>
                <div class="glass-card">
                    <h3>Actions</h3>
                    <button class="btn-action" style="margin-bottom:10px;" onclick="exportCSV()"><i class="fas fa-file-export"></i> Export Données</button>
                    <button class="btn-action" style="background:#64748b" onclick="alert('Configuration System')"><i class="fas fa-cog"></i> Config</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        let db = JSON.parse(localStorage.getItem('cvg_db_v2')) || [];
        let currentRole = "";
        let chartObj = null;

        function initApp(role) {
            currentRole = role;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('role-display').innerText = role;
            document.getElementById('role-display').style.background = (role==='MANAGER'?'#e0f2fe':role==='MAINTENANCE'?'#fef3c7':'#fee2e2');
            
            // Show correct section
            document.querySelectorAll('.app-section').forEach(s => s.style.display = 'none');
            document.getElementById('sec-' + role).style.display = 'block';
            
            refreshUI();
        }

        function createAlert() {
            const mach = document.getElementById('op-mach').value;
            db.unshift({
                id: Date.now(),
                mach: mach,
                start: new Date().toISOString(),
                end: null,
                status: 'OPEN',
                dur: 0
            });
            save();
            alert("Alerte envoyée à la Maintenance !");
        }

        function save() {
            localStorage.setItem('cvg_db_v2', JSON.stringify(db));
            refreshUI();
        }

        function refreshUI() {
            if(currentRole === 'OPERATEUR') {
                const hist = document.getElementById('op-history');
                hist.innerHTML = db.slice(0, 5).map(x => `
                    <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                        <span>${x.mach}</span>
                        <b style="color:${x.status==='OPEN'?'red':'green'}">${x.status}</b>
                    </div>
                `).join('');
            }

            if(currentRole === 'MAINTENANCE') {
                const list = document.getElementById('maint-list');
                const openPannes = db.filter(x => x.status === 'OPEN');
                if(openPannes.length > 0) document.getElementById('notifSound').play();
                
                list.innerHTML = openPannes.length ? openPannes.map(x => `
                    <div class="glass-card" style="border-left:8px solid var(--danger); display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h2 style="color:var(--danger)">${x.mach}</h2>
                            <small>Signalé à: ${new Date(x.start).toLocaleTimeString()}</small>
                        </div>
                        <button class="btn-action" style="width:auto; background:var(--success)" onclick="closePanne(${x.id})">RÉPARÉ / CLOTURER</button>
                    </div>
                `).join('') : '<p>Aucune panne en cours. Bon travail !</p>';
            }

            if(currentRole === 'MANAGER') {
                updateManagerStats();
            }
        }

        function closePanne(id) {
            const idx = db.findIndex(x => x.id === id);
            db[idx].end = new Date().toISOString();
            db[idx].status = 'CLOSED';
            db[idx].dur = Math.round((new Date() - new Date(db[idx].start)) / 60000);
            save();
        }

        function updateManagerStats() {
            const finished = db.filter(x => x.status === 'CLOSED');
            const totalDur = finished.reduce((a, b) => a + b.dur, 0);
            
            document.getElementById('st-count').innerText = db.length;
            document.getElementById('st-mttr').innerText = finished.length ? Math.round(totalDur / finished.length) + "m" : "0m";
            
            // Chart
            const ctx = document.getElementById('managerChart').getContext('2d');
            if(chartObj) chartObj.destroy();
            chartObj = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: finished.slice(0, 5).map(x => x.mach),
                    datasets: [{
                        label: 'Durée Panne (Min)',
                        data: finished.slice(0, 5).map(x => x.dur),
                        backgroundColor: '#00d4ff'
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        function exportCSV() {
            let csv = "ID,Machine,Debut,Fin,Duree\n";
            db.forEach(x => csv += `${x.id},${x.mach},${x.start},${x.end},${x.dur}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "CVG_Report.csv";
            a.click();
        }

        // Auto Refresh
        setInterval(refreshUI, 5000);
    </script>
</body>
</html>
