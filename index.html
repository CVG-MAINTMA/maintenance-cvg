<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMAO CVG - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1a2a6c;
            --danger: #b21f1f;
            --success: #1d976c;
            --bg: #f4f7f6;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); }
        
        /* Navigation */
        nav { background: var(--primary); display: flex; justify-content: space-around; padding: 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        nav button { background: rgba(255,255,255,0.1); border: 1px solid white; color: white; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: 0.3s; }
        nav button:hover { background: white; color: var(--primary); }

        .container { padding: 20px; max-width: 1000px; margin: auto; }
        .interface { display: none; animation: fadeIn 0.4s; }
        .active { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Formulaire */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-submit { background: var(--danger); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Tickets Maintenance */
        .ticket { background: white; border-left: 8px solid var(--danger); padding: 15px; margin-bottom: 15px; border-radius: 8px; position: relative; display: flex; justify-content: space-between; align-items: center; }
        .ticket.termin√© { border-left-color: var(--success); opacity: 0.7; }
        .ticket-info h3 { margin: 0; color: var(--primary); }
        .btn-fix { background: var(--success); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }

        /* Manager Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--primary); }
        .stat-card h1 { margin: 10px 0; font-size: 2.5rem; color: var(--primary); }
    </style>
</head>
<body>

<nav>
    <button onclick="switchTab('op')">üë®‚Äçüîß Op√©rateur</button>
    <button onclick="switchTab('maint')">üõ†Ô∏è Maintenance</button>
    <button onclick="switchTab('mgr')">üìä Manager</button>
</nav>

<div class="container">
    <section id="op" class="interface active">
        <div class="card">
            <h2>Signaler un Arr√™t Machine</h2>
            <form id="pannesForm">
                <input type="text" id="machine" placeholder="Code Machine (ex: MC-01)" required>
                <select id="type">
                    <option value="Coupure">Probl√®me Coupure</option>
                    <option value="Sertissage">Sertissage / Crimp</option>
                    <option value="Electrique">Panne √âlectrique</option>
                    <option value="Mecanique">Panne M√©canique</option>
                </select>
                <textarea id="description" placeholder="Description du probl√®me..."></textarea>
                <button type="submit" class="btn-submit">ENVOYER L'ALERTE</button>
            </form>
        </div>
    </section>

    <section id="maint" class="interface">
        <h2>Alertes Maintenance en Direct</h2>
        <div id="ticketsList">
            </div>
    </section>

    <section id="mgr" class="interface">
        <h2>Performance de l'Usine (KPIs)</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <p>Total Arr√™ts</p>
                <h1 id="totalArrets">0</h1>
            </div>
            <div class="stat-card">
                <p>MTTR Moyen (min)</p>
                <h1 id="mttrValue">0</h1>
            </div>
        </div>
        <div class="card">
            <canvas id="kpiChart"></canvas>
        </div>
    </section>
</div>

<script type="module">
    // L-app dyalk deja m-connectya m3a Firebase (config dyalk khass t-kon hna)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        // Hna khass t-kon l-config dyalk lli mkhlliha f-Firebase Console
        apiKey: "VOTRE_API_KEY",
        authDomain: "votre-projet.firebaseapp.com",
        projectId: "votre-projet-id",
        storageBucket: "votre-projet.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const pannesCol = collection(db, "pannes_cvg");

    // NAVIGATION
    window.switchTab = (id) => {
        document.querySelectorAll('.interface').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    };

    // OPERATEUR: Envoi
    document.getElementById('pannesForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await addDoc(pannesCol, {
            machine: document.getElementById('machine').value,
            type: document.getElementById('type').value,
            desc: document.getElementById('description').value,
            status: "Ouvert",
            startTime: Date.now(),
            createdAt: serverTimestamp()
        });
        alert("Alerte envoy√©e !");
        e.target.reset();
    });

    // MAINTENANCE & MANAGER: R√©cup√©ration Real-time
    const q = query(pannesCol, orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById('ticketsList');
        list.innerHTML = "";
        let dataForKpi = [];

        snapshot.forEach(docSnap => {
            const item = { id: docSnap.id, ...docSnap.data() };
            dataForKpi.push(item);

            // Create Ticket UI
            const div = document.createElement('div');
            div.className = `ticket ${item.status === 'Termin√©' ? 'termin√©' : ''}`;
            div.innerHTML = `
                <div class="ticket-info">
                    <h3>${item.machine} - ${item.type}</h3>
                    <p>${item.desc}</p>
                    <small>Statut: <strong>${item.status}</strong></small>
                </div>
                ${item.status === 'Ouvert' ? `<button class="btn-fix" onclick="cloturer('${item.id}')">R√©par√© ‚úÖ</button>` : ''}
            `;
            list.appendChild(div);
        });

        updateKPIs(dataForKpi);
    });

    // MAINTENANCE: Fermer le ticket
    window.cloturer = async (id) => {
        const ticketRef = doc(db, "pannes_cvg", id);
        await updateDoc(ticketRef, {
            status: "Termin√©",
            endTime: Date.now()
        });
    };

    // MANAGER: Calcul KPIs
    function updateKPIs(data) {
        document.getElementById('totalArrets').innerText = data.length;
        
        let totalMttr = 0;
        let countTermin√© = 0;
        data.forEach(d => {
            if(d.endTime) {
                totalMttr += (d.endTime - d.startTime) / 60000;
                countTermin√©++;
            }
        });
        document.getElementById('mttrValue').innerText = countTermin√© > 0 ? (totalMttr / countTermin√©).toFixed(1) : 0;
    }
</script>

</body>
</html>
