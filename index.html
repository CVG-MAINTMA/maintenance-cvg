<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CVG GMAO - Live Vibration</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #002b5c; --danger: #ef4444; --success: #22c55e; --bg: #f8fafc; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); padding: 10px; }
        .app-container { max-width: 500px; margin: 0 auto; }
        header { background: var(--primary); color: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #64748b; font-size: 0.9rem; }
        select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0; font-size: 16px; margin-bottom: 15px; background: white; }
        .btn-send { width: 100%; padding: 18px; background: var(--danger); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 0 #b91c1c; }
        .btn-send:active { transform: translateY(2px); box-shadow: 0 2px 0 #b91c1c; }
        
        #notifList { margin-top: 20px; }
        .notif-item { 
            background: white; border-left: 8px solid var(--danger); padding: 15px; border-radius: 12px; 
            margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.1); animation: alertShake 0.5s infinite alternate;
        }

        @keyframes alertShake {
            from { transform: translateX(0); }
            to { transform: translateX(5px); }
        }

        .btn-ok { background: var(--success); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .info-box { font-size: 0.7rem; color: #94a3b8; text-align: center; margin-top: 10px; }
    </style>
</head>
<body onclick="enableAudio()"> <div class="app-container">
        <header>
            <h3>CVG GMAO <span style="font-size: 0.6rem; color: #38bdf8;">PRO-VIBE</span></h3>
            <div id="connection-status" style="font-size: 0.7rem; color: #22c55e;"><i class="fas fa-circle"></i> Live</div>
        </header>

        <div class="card">
            <label><i class="fas fa-industry"></i> Machine</label>
            <select id="machineSelect">
                <option value="KOMAX-01">KOMAX 01</option>
                <option value="SCHUNK-04">SCHUNK 04</option>
                <option value="BAN-TEST-02">BANC TEST 02</option>
                <option value="PRESS-03">PRESSE 03</option>
            </select>
            <label><i class="fas fa-exclamation-circle"></i> Type de Panne</label>
            <select id="panneType">
                <option value="M√©canique">üîß M√©canique</option>
                <option value="√âlectrique">‚ö° √âlectrique</option>
                <option value="Qualit√©">‚ùå Qualit√©</option>
            </select>
            <button class="btn-send" onclick="sendAlert()">SAYFAT ALERTE <i class="fas fa-bullhorn"></i></button>
            <p class="info-box">Cliquer n'importe o√π pour activer le son</p>
        </div>

        <div id="notifList"></div>
    </div>

    <audio id="alertSound" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyASQa5cLXFllnV6EmYp-ARZ9dndWSKha6c",
            authDomain: "cvgmaroc-gmao.firebaseapp.com",
            databaseURL: "https://cvgmaroc-gmao-default-rtdb.firebaseio.com",
            projectId: "cvgmaroc-gmao",
            storageBucket: "cvgmaroc-gmao.firebasestorage.app",
            messagingSenderId: "72908747564",
            appId: "1:72908747564:web:82f646ef5dd209d03b7289",
            measurementId: "G-FP17SNE4VB"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const sound = document.getElementById('alertSound');
        let audioEnabled = false;

        function enableAudio() {
            audioEnabled = true;
            console.log("Audio Enabled");
        }

        // 1. Sift Alerte
        function sendAlert() {
            const machine = document.getElementById('machineSelect').value;
            const type = document.getElementById('panneType').value;
            const time = new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
            
            database.ref('pannes/').push({
                machine: machine,
                type: type,
                time: time,
                status: 'OPEN'
            }).then(() => {
                if (navigator.vibrate) navigator.vibrate(200);
            });
        }

        // 2. Iisti9bal Alertes (Real-time)
        database.ref('pannes/').on('value', (snapshot) => {
            const data = snapshot.val();
            const container = document.getElementById('notifList');
            container.innerHTML = "";
            let activeAlerts = false;

            if (data) {
                Object.keys(data).reverse().forEach(key => {
                    const p = data[key];
                    if(p.status === 'OPEN') {
                        activeAlerts = true;
                        container.innerHTML += `
                            <div class="notif-item">
                                <div>
                                    <b style="color:var(--primary); font-size:1.1rem;">${p.machine}</b><br>
                                    <span style="color:var(--danger); font-weight:bold;">${p.type}</span><br>
                                    <small><i class="far fa-clock"></i> ${p.time}</small>
                                </div>
                                <button class="btn-ok" onclick="closeP('${key}')">RE√áU</button>
                            </div>`;
                    }
                });
            }

            // Trigger Sawt & Vibration ila kayna alert
            if (activeAlerts) {
                if (audioEnabled) sound.play();
                if (navigator.vibrate) {
                    // Pattern: Vibre 500ms, sber 200ms, vibre 500ms
                    navigator.vibrate([500, 200, 500, 200, 500]);
                }
            } else {
                sound.pause();
                sound.currentTime = 0;
            }
        });

        function closeP(key) {
            database.ref('pannes/' + key).update({status: 'CLOSED'});
        }
    </script>
</body>
</html>
